<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?= htmlspecialchars($page_title) ?></title>
    <link id="favicon" rel="icon" href="<?= htmlspecialchars($favicon) ?>" type="image/x-icon">
    <?php foreach ($stylesheets as $stylesheet_url): ?>
        <link rel="stylesheet" href="<?= htmlspecialchars($stylesheet_url) ?>" class="skin-stylesheet">
    <?php endforeach; ?>
    <link rel="stylesheet" id="module-stylesheet" href="<?= htmlspecialchars($module_stylesheet ?? '') ?>" class="skin-stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Montserrat:wght@300;400;600&family=Playfair+Display:wght@400;500;600&display=swap" rel="stylesheet">

</head>

<body data-client-id="<?= htmlspecialchars($client_id) ?>" data-initial-context='<?= $initial_context_json ?>' data-base-url="<?= htmlspecialchars($base_url) ?>">
    <div class="nav-panel" id="nav-panel">
        <ul>
            <?php foreach ($navigable_modules as $navModule): ?>
                <li>
                    <?php if ($navModule['type'] === 'link'): ?>
                        <a href="<?= htmlspecialchars($navModule['url']) ?>" class="nav-link is-external" target="_blank" rel="noopener noreferrer">
                            <?= htmlspecialchars($navModule['title']) ?>
                        </a>
                    <?php else: ?>
                        <a href="#" class="nav-link" data-module-id="<?= htmlspecialchars($navModule['id']) ?>">
                            <?= htmlspecialchars($navModule['title']) ?>
                        </a>
                    <?php endif; ?>
                </li>
            <?php endforeach; ?>
        </ul>
    </div>
    <header class="nav-header">
        <?php if (!empty($logo_url)): ?>
            <img src="<?= htmlspecialchars($logo_url) ?>" alt="Logo" class="header-logo">
        <?php else: ?>
            <h1 id="page-main-title"><?= htmlspecialchars($page_title) ?></h1>
        <?php endif; ?>
        <button class="hamburger-button" id="hamburger-button">&#9776;</button>
    </header>
    <div id="app-container">
        <main id="module-content-wrapper">
            <?= $content ?>
        </main>
    </div>

    <script src="<?= htmlspecialchars($base_url) ?>asset/js/event-handler.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const navPanel = document.getElementById('nav-panel');
        const hamburgerBtn = document.getElementById('hamburger-button');
        const appContainer = document.getElementById('module-content-wrapper');
        const clientId = document.body.dataset.clientId;
        const baseUrl = document.body.dataset.baseUrl;

        hamburgerBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            navPanel.classList.toggle('open');
        });

        document.addEventListener('click', (e) => {
            if (navPanel.classList.contains('open') && !navPanel.contains(e.target)) {
                navPanel.classList.remove('open');
            }
        });

        navPanel.addEventListener('click', async (e) => {
            const link = e.target.closest('.nav-link');
            if (!link) return;

            // Si es un enlace externo, solo cierra el panel y deja que el navegador haga el resto.
            if (link.classList.contains('is-external')) {
                navPanel.classList.remove('open');
                return;
            }

            // Si es un enlace de módulo interno, previene la navegación y carga el contenido.
            e.preventDefault();
            navPanel.classList.remove('open');
            const moduleId = link.dataset.moduleId;
            
            if (!clientId || !moduleId) {
                appContainer.innerHTML = `<div class='app-error'>Error: No se pudo determinar el cliente o el módulo.</div>`;
                return;
            }

            appContainer.innerHTML = `<h2>Cargando...</h2>`;
            
            try {
                const response = await fetch(`${baseUrl}api/getModule.php?client=${clientId}&id=${moduleId}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || `Error en la respuesta de la API: ${response.statusText}`);
                }

                // Se espera una respuesta JSON
                const data = await response.json();

                // Se actualiza el contenido HTML
                appContainer.innerHTML = data.html;

                // Se busca el <link> del CSS del módulo y se actualiza su 'href'
                const moduleStylesheet = document.getElementById('module-stylesheet');
                if (moduleStylesheet && data.hasOwnProperty('css_url')) {
                    // Se actualiza la URL. Si es null, se pone vacía para desactivar la hoja anterior.
                    moduleStylesheet.href = data.css_url || '';
                }

            } catch (error) {
                console.error('Error al cargar el módulo:', error);
                appContainer.innerHTML = `<div class='app-error'>No se pudo cargar el módulo.<br><small>${error.message}</small></div>`;
            }
        });
    });
    </script>
</body>
</html>