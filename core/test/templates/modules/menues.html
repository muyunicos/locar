<?php

if (!function_exists("render_admin_controls")) {
    function render_admin_controls(bool $is_admin, bool $is_category)
    {
        if ($is_admin) {
            // Este include es correcto, el JS buscarÃ¡ los controles dentro del contenedor.
            include(PRIVATE_PATH . '/templates/admin/menues/controls.html');
        }
    }
}

if (!function_exists("render_image")) {
    function render_image($url, $alt = "", $class = "", $loading = "lazy")
    {
        if (empty($url)) return;
        ?>
        <img src="<?= htmlspecialchars($url) ?>" alt="<?= htmlspecialchars($alt) ?>" <?= !empty($class) ? 'class="' . htmlspecialchars($class) . '"' : "" ?> <?= !empty($loading) ? 'loading="' . htmlspecialchars($loading) . '"' : "" ?> />
        <?php
    }
}

if (!function_exists("render_item")) {
    function render_item($items_array, $is_admin = false)
    {
        if (empty($items_array)) return;

        foreach ($items_array as $item) {
            if (isset($item["hidden"]) && $item["hidden"]) continue;
            
            $has_image = !empty($item["imagen_url"]);
            $is_category = isset($item["es_cat"]) && $item["es_cat"];

            // Pasamos el nombre del archivo de origen para usarlo al guardar
            $data_source_attr = isset($item["data_source_file"]) ? 'data-source-file="' . htmlspecialchars($item["data_source_file"]) . '"' : '';

            if ($is_category) { ?>
                <div class="c-container <?= isset($item["layout"]) ? htmlspecialchars($item["layout"]) : "" ?>" 
                    data-item-json='<?= htmlspecialchars(json_encode($item), ENT_QUOTES, 'UTF-8') ?>' 
                    data-module-id="menues_category" <?= $data_source_attr ?>>
                    
                    <h3 class="c-titulo">
                        <div class="c-titulo-content">
                            <span data-editable="true"><?= htmlspecialchars($item["titulo"]) ?></span>
                            <?php if (!empty($item["descripcion"])): ?>
                                <small class="c-titulo-descripcion" data-editable="true"><?= htmlspecialchars($item["descripcion"]) ?></small>
                            <?php endif; ?>
                        </div>
                        <?php if ($has_image): render_image($item["imagen_url"]); endif; ?>
                        
                        <?php render_admin_controls($is_admin, $is_category); ?>
                    </h3>

                    <div class="item-list">
                        <?php render_item($item["items"], $is_admin);  ?>
                    </div>
                </div>
            <?php } else { ?>
                <div class="item" data-item-json='<?= htmlspecialchars(json_encode($item), ENT_QUOTES, 'UTF-8') ?>'>
                    <?php if ($has_image): ?>
                        <div class="item-imagen-wrapper">
                            <?php render_image($item["imagen_url"], $item["titulo"]); ?>
                        </div>
                    <?php endif; ?>

                    <div class="item-details">
                        <div class="item-info">
                            <h3 class="item-titulo" data-editable="true"><?= htmlspecialchars($item["titulo"]) ?></h3>
                            <?php if (!empty($item["descripcion"])): ?>
                                <p class="item-descripcion" data-editable="true"><?= htmlspecialchars($item["descripcion"]) ?></p>
                            <?php endif; ?>
                        </div>
                        <div class="item-precio">
                            <?php if (isset($item["original_price"])): ?>
                                <span class="precio-original">
                                    <span class="precio-simbolo">$</span>
                                    <span class="precio-valor"><?= htmlspecialchars(number_format($item["original_price"], 0, ",", ".")) ?></span>
                                    <span class="precio-decimales">,-</span>
                                </span>
                            <?php endif; ?>
                            <span class="precio-final">
                                <span class="precio-simbolo">$</span>
                                <span class="precio-valor" data-editable="true"><?= htmlspecialchars(number_format($item["precio"], 0, ",", ".")) ?></span>
                                <span class="precio-decimales">,-</span>
                            </span>
                        </div>
                    </div>
                    <?php render_admin_controls($is_admin, $is_category); ?>
                </div>
            <?php }
        }
    }
}
?>

<div class="module-container module-menues" data-module-id="menues" data-source-file="<?= htmlspecialchars($dataSourceFile) ?>">
    
    <?php if (!empty($menu_image_url)): ?>
        <div class="menu-header-image-container">
            <?php render_image($menu_image_url, $menu_title); ?>
        </div>
    <?php else: ?>
        <h2 class="menues-title" data-editable="true"><?= htmlspecialchars($menu_title) ?></h2>
    <?php endif; ?>

    <?php if (isset($error) && !empty($error)): ?>
        <p class="app-error"><?= htmlspecialchars($error) ?></p>
    <?php else: ?>
        <div class="item-list">
            <?php render_item($items, $is_admin ?? false); ?>
        </div>
    <?php endif; ?>

    <?php if (!empty($footer_text)): ?>
        <footer class="menu-footer">
            <p data-editable="true"><?= htmlspecialchars($footer_text) ?></p>
        </footer>
    <?php endif; ?>
</div>