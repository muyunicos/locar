<?php
if (!function_exists("render_public_image")) {
    function render_public_image($url, $alt = "", $class = "", $loading = "lazy") {
        if (empty($url)) return;
        echo '<img src="' . htmlspecialchars($url) . '" alt="' . htmlspecialchars($alt) . '"' . (!empty($class) ? ' class="' . htmlspecialchars($class) . '"' : "") . ' loading="lazy" />';
    }
}

if (!function_exists("render_public_item")) {
    function render_public_item($items_array) {
        if (empty($items_array)) return;
        foreach ($items_array as $item) {
            if (isset($item["ocultar"]) && $item["ocultar"]) continue;
            
            $has_image = !empty($item["imagen_url"]);
            $is_category = isset($item["es_cat"]) && $item["es_cat"];

            if ($is_category) { ?>
                <div class="c-container <?= isset($item["layout"]) ? htmlspecialchars($item["layout"]) : "" ?>" data-id="<?= htmlspecialchars($item['id']) ?>">
                    <h3 class="c-titulo">
                        <div class="c-titulo-content">
                            <span><?= htmlspecialchars($item["titulo"]) ?></span>
                            <?php if (!empty($item["descripcion"])): ?><small class="c-titulo-descripcion"><?= htmlspecialchars($item["descripcion"]) ?></small><?php endif; ?>
                        </div>
                        <?php if ($has_image) { render_public_image($item["imagen_url"], $item["titulo"]); } ?>
                    </h3>
                    <div class="item-list"><?php render_public_item($item["items"]); ?></div>
                </div>
            <?php } else { ?>
                <div class="item" data-id="<?= htmlspecialchars($item['id']) ?>">
                    <?php if ($has_image): ?>
                        <div class="item-imagen-wrapper">
                           <?php render_public_image($item["imagen_url"], $item["titulo"]); ?>
                        </div>
                    <?php endif; ?>
                    <div class="item-details">
                        <div class="item-info">
                            <h3 class="item-titulo"><?= htmlspecialchars($item["titulo"]) ?></h3>
                            <?php if (!empty($item["descripcion"])): ?><p class="item-descripcion"><?= htmlspecialchars($item["descripcion"]) ?></p><?php endif; ?>
                        </div>
                        <div class="item-precio">
                             <?php if (isset($item["original_price"])): ?><span class="precio-original">$<?= htmlspecialchars(number_format($item["original_price"], 0, ",", ".")) ?></span><?php endif; ?>
                            <span class="precio-final">$<?= htmlspecialchars(number_format($item["precio"], 0, ",", ".")) ?></span>
                        </div>
                    </div>
                </div>
            <?php }
        }
    }
}
?>

<div 
    id="menu-container" 
    class="module-container module-menues" 
    data-module-id="menues"
    <?php if ($is_admin ?? false): ?>
        data-source-file="<?= htmlspecialchars($dataSourceFile ?? '') ?>"
        data-initial-json='<?= htmlspecialchars(json_encode($module_data), ENT_QUOTES, 'UTF-8') ?>'
    <?php endif; ?>
>
    <?php if ($is_admin ?? false): ?>
        <div id="admin-floating-controls" class="admin-controls">
            <?php include(PRIVATE_PATH . '/templates/admin/menues/controls.html'); ?>
        </div>
        <?php include(PRIVATE_PATH . '/templates/admin/menues/fab.html'); ?>
    <?php endif; ?>

    <?php if (!empty($imagen)): ?>
        <div class="menu-header-image-container"><?php render_public_image($imagen, $menu_title ?? ''); ?></div>
    <?php else: ?>
        <h2 class="menues-title"><?= htmlspecialchars($menu_title ?? '') ?></h2>
    <?php endif; ?>

    <?php if (isset($error) && !empty($error)): ?>
        <p class="app-error"><?= htmlspecialchars($error) ?></p>
    <?php else: ?>
        <div id="item-list-container" class="item-list">
            <?php
                if (!($is_admin ?? false)) {
                    render_public_item($items ?? []); 
                }
            ?>
        </div>
    <?php endif; ?>

    <?php if (!empty($footer_text)): ?>
        <footer class="menu-footer">
            <p><?= htmlspecialchars($footer_text) ?></p>
        </footer>
    <?php endif; ?>
</div>